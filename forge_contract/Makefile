-include .env

.PHONY: build deploy test test-fork clean remove install update snapshot format anvil deploy-sepolia copy-abi help

# Default private key for Anvil's deterministic accounts
DEFAULT_ANVIL_KEY := 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

# Default RPC URL for Anvil
DEFAULT_ANVIL_RPC_URL := http://localhost:8545

# Define the script file to be deployed
SCRIPT_FILE := script/DeployCrowdFunding.s.sol:DeployCrowdFundingWithCampaigns

# --- NETWORK CONFIGURATION ---
# Default NETWORK_ARGS for local Anvil deployment
# This uses the '?' operator, meaning it will only set NETWORK_ARGS if it hasn't been set already.
NETWORK_ARGS ?= --rpc-url $(DEFAULT_ANVIL_RPC_URL) --private-key $(DEFAULT_ANVIL_KEY) --broadcast

# Conditional override for NETWORK_ARGS if 'NETWORK=sepolia' is passed on the command line
# This checks the 'NETWORK' variable, which you set when running 'make'.
ifeq ($(NETWORK), sepolia)
    NETWORK_ARGS := --rpc-url $(SEPOLIA_RPC_URL) --private-key $(PRIVATE_KEY) --broadcast --verify --etherscan-api-key $(ETHERSCAN_API_KEY) -vvvv
endif
# --- END NETWORK CONFIGURATION ---


help:
	@echo "ğŸš€ Crowdfunding DApp - Makefile Commands"
	@echo "========================================"
	@echo ""
	@echo "ğŸ“‹ Usage: make [target] [NETWORK=sepolia]"
	@echo ""
	@echo "ğŸ”¨ Build & Test:"
	@echo "  build          Build the smart contracts"
	@echo "  test           Run all tests"
	@echo "  test-fork      Run tests against forked Sepolia network"
	@echo "  snapshot       Create gas usage snapshot"
	@echo "  format         Format Solidity files"
	@echo ""
	@echo "ğŸš€ Deployment:"
	@echo "  deploy         Deploy to local Anvil (default) or Sepolia (NETWORK=sepolia)"
	@echo "  deploy-sepolia Deploy specifically to Sepolia testnet"
	@echo ""
	@echo "ğŸ› ï¸  Development:"
	@echo "  anvil          Start local Anvil blockchain"
	@echo "  copy-abi       Copy contract ABI to frontend"
	@echo ""
	@echo "ğŸ§¹ Maintenance:"
	@echo "  clean          Clean build artifacts"
	@echo "  install        Install Foundry dependencies"
	@echo "  update         Update Foundry dependencies"
	@echo "  remove         Remove git submodules"
	@echo ""
	@echo "ğŸ’¡ Examples:"
	@echo "  make deploy                    # Deploy to local Anvil"
	@echo "  make deploy NETWORK=sepolia    # Deploy to Sepolia testnet"
	@echo "  make test                      # Run all tests"

# ============================================================================
# BUILD & TEST COMMANDS
# ============================================================================

build:
	@echo "ğŸ”¨ Building smart contracts..."
	forge build
	@echo "âœ… Build completed!"

test:
	@echo "ğŸ§ª Running tests..."
	forge test
	@echo "âœ… Tests completed!"

test-fork:
	@echo "ğŸŒ Running tests against Sepolia fork..."
	forge test --fork-url $(SEPOLIA_RPC_URL)
	@echo "âœ… Fork tests completed!"

snapshot:
	@echo "ğŸ“Š Creating gas snapshot..."
	forge snapshot
	@echo "âœ… Snapshot created!"

format:
	@echo "ğŸ¨ Formatting Solidity files..."
	forge fmt
	@echo "âœ… Formatting completed!"

# ============================================================================
# UTILITY COMMANDS
# ============================================================================

# Copy ABI to frontend after build
copy-abi:
	@echo "ğŸ“‹ Copying ABI to frontend..."
	@cp out/CrowdFunding.sol/CrowdFunding.json ../frontend/constants/CrowdFunding.json
	@echo "âœ… ABI copied successfully!"

# Clean the project
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	forge clean
	@echo "âœ… Clean completed!"

# Install dependencies
install:
	@echo "ğŸ“¦ Installing Foundry dependencies..."
	forge install cyfrin/foundry-devops@0.2.2 && forge install smartcontractkit/chainlink-brownie-contracts@1.1.1 && forge install foundry-rs/forge-std@v1.8.2
	@echo "âœ… Dependencies installed!"

# Update dependencies
update:
	@echo "ğŸ”„ Updating Foundry dependencies..."
	forge update
	@echo "âœ… Dependencies updated!"

# Remove modules
remove:
	@echo "ğŸ—‘ï¸  Removing git submodules..."
	rm -rf .gitmodules && rm -rf .git/modules/* && rm -rf lib && touch .gitmodules && git add . && git commit -m "modules"
	@echo "âœ… Modules removed!"

# ============================================================================
# DEVELOPMENT COMMANDS
# ============================================================================

# Run anvil with deterministic accounts and 1-second block time
anvil:
	@echo "ğŸ”— Starting local Anvil blockchain..."
	anvil -m 'test test test test test test test test test test test junk' \
		--steps-tracing \
		--block-time 1



# ============================================================================
# DEPLOYMENT COMMANDS
# ============================================================================

# Main deploy target - uses NETWORK_ARGS which is conditionally set above
deploy:
	@echo "ğŸš€ Deploying contracts..."
	forge script ${SCRIPT_FILE} ${NETWORK_ARGS}
	@echo "ğŸ“‹ Copying ABI to frontend..."
	@cp out/CrowdFunding.sol/CrowdFunding.json ../frontend/constants/CrowdFunding.json
	@echo "âœ… Deployment completed!"

# Specific deploy target for Sepolia (can be used, but 'deploy NETWORK=sepolia' is more flexible)
deploy-sepolia:
	@echo "ğŸŒ Deploying to Sepolia testnet..."
	forge script ${SCRIPT_FILE} --rpc-url $(SEPOLIA_RPC_URL) --account $(ACCOUNT_NAME) --broadcast --verify --etherscan-api-key $(ETHERSCAN_API_KEY) -vvvv
	@echo "ğŸ“‹ Copying ABI to frontend..."
	@cp out/CrowdFunding.sol/CrowdFunding.json ../frontend/constants/CrowdFunding.json
	@echo "âœ… Sepolia deployment completed!"


